#!/usr/bin/env bash
#
# Check if logged into OpenShift cluster
echo "Checking OpenShift login status..."
if ! oc whoami &>/dev/null; then
    echo "Error: Not logged into OpenShift cluster"
    echo "Please log in and try again"
    exit 1
fi

# Get current user and server info
CURRENT_USER=$(oc whoami)
CURRENT_SERVER=$(oc whoami --show-server)
echo "Logged in as: $CURRENT_USER"
echo "Connected to: $CURRENT_SERVER"

echo "Fetching L3 Enablement related info from OpenShift..."

# Get the console URL from the console route
OPENSHIFT_CLUSTER_CONSOLE_URL=$(oc get route console -n openshift-console -o jsonpath='{.spec.host}')
if [ -z "$OPENSHIFT_CLUSTER_CONSOLE_URL" ]; then
    echo "Error: Could not retrieve console URL"
    exit 1
fi
echo "Console URL: https://$OPENSHIFT_CLUSTER_CONSOLE_URL"

# get ingress domain from ingresscontroller
OPENSHIFT_CLUSTER_INGRESS_DOMAIN=$(oc get ingresscontroller default -n openshift-ingress-operator -o jsonpath='{.status.domain}')
if [ -z "$OPENSHIFT_CLUSTER_INGRESS_DOMAIN" ]; then
    echo "Error: Could not determine ingress domain"
    exit 1
fi
echo "Ingress domain: $OPENSHIFT_CLUSTER_INGRESS_DOMAIN"


echo "Starting build process..."
echo "Removing old site..."
rm -rf ./www/*
echo "Building new site..."

podman run --rm --name showroom-builder --platform linux/amd64 \
  -v "./:/antora:z" \
  docker.io/antora/antora --attribute openshift_console_url="https://$OPENSHIFT_CLUSTER_CONSOLE_URL" \
  --attribute openshift_cluster_ingress_domain="$OPENSHIFT_CLUSTER_INGRESS_DOMAIN" \
  --attribute product_name_rhdh="Red Hat Developer Hub" \
  default-site.yml

echo "Build process complete. Check the ./www folder for the generated site."
echo "To view the site locally, run the following command: utilities/lab-serve"
echo "If already running then browse to http://localhost:8080/index.html"
